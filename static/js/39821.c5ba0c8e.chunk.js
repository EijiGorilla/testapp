"use strict";(self.webpackChunktestapp=self.webpackChunktestapp||[]).push([[39821],{9559:(e,t,l)=>{l.d(t,{A:()=>c});var s=l(35143),i=l(91967),a=l(18690),n=l(19276),r=l(3975),o=l(50346),d=l(46053),u=(l(81806),l(76460),l(85842)),h=l(85248),y=l(91885);let p=class extends i.default{constructor(e){super(e),this.state="disabled",this._valueBeforeReady=null,this._domainInfo=(0,y.$m)([]),this._loadLayers=(0,h.P)(),this.layers=new n.default}initialize(){this.addHandles(this.layers.on("change",(()=>this._onLayersChange()))),this._onLayersChange()}destroy(){this._set("state","disabled")}get enabled(){return this.allowedValues.length>0&&this._get("enabled")}set enabled(e){e!==this.enabled&&this.allowedValues.length>0&&this._set("enabled",e)}get value(){return("ready"===this.state?this._get("value"):this._valueBeforeReady)??0}set value(e){if("ready"!==this.state)return void(this._valueBeforeReady=e);if(e===this.value)return;const t=(0,y.IM)(e,this);null!=t&&this._set("value",t)}get min(){return(0,y.pg)(this.allowedValues)}get max(){return(0,y.Lu)(this.allowedValues)}get allowedValues(){return this._domainInfo.allowedValues}set allowedValues(e){null==e?this._clearOverride("allowedValues"):this._override("allowedValues",e);const t=(0,y.IM)(this.value,this);null!=t&&(this.value=t)}get hasNext(){if(!this.enabled)return!0;const e=this._valueIndex;return e>=0&&e<this.allowedValues.length-1}get hasPrevious(){return!this.enabled||this._valueIndex>0}set layers(e){const t=this._get("layers");this._set("layers",(0,r.V)(e,t))}get filterExpressions(){return{solid:null,xRay:null}}get _valueIndex(){return(0,a.FQ)(this.allowedValues,this.value)}select(e){"ready"===this.state?null!=(0,y.IM)(e,this)&&(this.enabled=!0,this.value=e):this._valueBeforeReady=e}clear(){"ready"===this.state?this.enabled=!1:this._valueBeforeReady=null}next(){const{state:e,allowedValues:t,enabled:l,hasNext:s,_valueIndex:i}=this;if("ready"===e||null==this._valueBeforeReady){if(0!==t.length)return l?void(s&&(this.value=t[i+1])):(this.enabled=!0,void(this.value=t[0]))}else this._valueBeforeReady++}previous(){const{state:e,allowedValues:t,enabled:l,hasPrevious:s,_valueIndex:i}=this;if("ready"===e||null==this._valueBeforeReady){if(0!==t.length)return l?void(s&&(this.value=t[i-1])):(this.enabled=!0,void(this.value=t[t.length-1]))}else this._valueBeforeReady++}getValueLabel(e){return 0===this.layers.length?null:this._domainInfo.fieldValueMap.get(e)??null}async _onLayersChange(){if(this._set("state","loading"),this._domainInfo=(0,y.$m)([]),0!==this.layers.length)try{await this._loadLayers(this.layers),this._setup()}catch(e){(0,o.isAbortError)(e)||this._set("state","failed")}}};(0,s._)([(0,d.MZ)({value:!1,nonNullable:!0})],p.prototype,"enabled",null),(0,s._)([(0,d.MZ)({nonNullable:!0})],p.prototype,"value",null),(0,s._)([(0,d.MZ)({readOnly:!0})],p.prototype,"min",null),(0,s._)([(0,d.MZ)({readOnly:!0})],p.prototype,"max",null),(0,s._)([(0,d.MZ)()],p.prototype,"allowedValues",null),(0,s._)([(0,d.MZ)({readOnly:!0})],p.prototype,"hasNext",null),(0,s._)([(0,d.MZ)({readOnly:!0})],p.prototype,"hasPrevious",null),(0,s._)([(0,d.MZ)({type:n.default,nonNullable:!0})],p.prototype,"layers",null),(0,s._)([(0,d.MZ)({nonNullable:!0})],p.prototype,"state",void 0),(0,s._)([(0,d.MZ)()],p.prototype,"_valueBeforeReady",void 0),(0,s._)([(0,d.MZ)({readOnly:!0})],p.prototype,"_valueIndex",null),(0,s._)([(0,d.MZ)()],p.prototype,"_domainInfo",void 0),p=(0,s._)([(0,u.$)("esri.widgets.BuildingExplorer.BuildingNumericFilterViewModel")],p);const c=p},36767:(e,t,l)=>{l.d(t,{PE:()=>u,Z4:()=>o,gK:()=>h,r$:()=>p,wI:()=>y});var s=l(49723),i=l(3244),a=l(73539),n=l(48650);const r="__BUILDING_EXPLORER_FILTER__";function o(){return`${(0,s.lk)()}${r}`}function d(e){const t="string"==typeof e?e:e.id;return!!t&&t.includes(r)}function u(e,t){for(const l of e.items)for(const e of l.filters.items){if(!d(e))continue;const l=t(e);if(null!=l)return l}return null}function h(e,t){e.forEach((e=>{const l=e.filters.filter((e=>!d(e)));null!=t&&l.push(t),function(e,t){const l=t.length;if(null==e||e.length!==l)return!1;for(let s=0;s<l;++s){const l=t.at(s).toJSON(),i=e.at(s).toJSON();if(l.id="",i.id="",JSON.stringify(l)!==JSON.stringify(i))return!1}return!0}(e.filters,l)||(e.filters=l);const s=e.filters.find((e=>d(e)));e.activeFilterId=null!=s?s.id:null}))}function y(e){const t=c(e);return t?new i.A({filterExpression:t,filterMode:new n.A}):null}function p(e){const t=c(e);return t?new i.A({filterExpression:t,filterMode:new a.A}):null}function c(e){return e.filter((e=>!!e)).map((e=>`(${e})`)).join(" AND ")}},37407:(e,t,l)=>{l.r(t),l.d(t,{default:()=>h});var s=l(35143),i=l(46053),a=(l(81806),l(76460),l(47249),l(85842)),n=l(9559),r=l(78168),o=l(36767),d=l(91885);let u=class extends n.A{constructor(e){super(e),this._createdPhaseFieldName=null,this._demolishedPhaseFieldName=null,this._parseValueFromFilter=e=>{const t=this._createdPhaseFieldName,l=new RegExp(`${t}\\s*<=\\s*(\\d+)\\s*OR\\s*${t}\\s*IS\\s*NULL`,"gi"),s=this._demolishedPhaseFieldName,i=new RegExp(`${s}\\s*>\\s*(\\d+)\\s*OR\\s*${s}\\s*IS\\s*NULL`,"gi");for(const{filterExpression:a}of e.filterBlocks?.items??[]){const e=a?l.exec(a)??i.exec(a):null;if(e)return parseInt(e[1],10)}return null}}get filterExpressions(){if(!this.enabled)return{solid:null,xRay:null};const e=[],t=this._createdPhaseFieldName;t&&e.push(`(${t} <= ${this.value} OR ${t} IS NULL)`);const l=this._demolishedPhaseFieldName;l&&e.push(`(${l} > ${this.value} OR ${l} IS NULL)`);const s=e.join(" AND ");return{solid:s,xRay:s}}get _lastValue(){const e=this.allowedValues;return e.length>0?e[e.length-1]:0}_setup(){const e=[];this.layers.forEach((t=>{const l=(0,r.BJ)(t,"createdphase");null!=l&&(this._createdPhaseFieldName=l.fieldName,e.push(l));const s=(0,r.BJ)(t,"demolishedphase");null!=s&&(this._demolishedPhaseFieldName=s.fieldName,e.push(s))})),this._domainInfo=(0,d.$m)(e);const t=this._valueBeforeReady;if(this._set("state","ready"),this._valueBeforeReady=null,this.allowedValues.length>0){const e=t??(0,o.PE)(this.layers,this._parseValueFromFilter);this.select(e??this._lastValue)}else this.clear()}};(0,s._)([(0,i.MZ)({readOnly:!0})],u.prototype,"filterExpressions",null),(0,s._)([(0,i.MZ)()],u.prototype,"_createdPhaseFieldName",void 0),(0,s._)([(0,i.MZ)()],u.prototype,"_demolishedPhaseFieldName",void 0),(0,s._)([(0,i.MZ)({readOnly:!0})],u.prototype,"_lastValue",null),u=(0,s._)([(0,a.$)("esri.widgets.BuildingExplorer.BuildingPhase")],u);const h=u},39821:(e,t,l)=>{l.r(t),l.d(t,{default:()=>N});var s=l(35143),i=l(91967),a=l(19276),n=l(3975),r=l(76460),o=l(50346),d=l(68134),u=l(46053),h=(l(81806),l(47249),l(85842)),y=l(62690),p=l(90770),c=l(78168),f=l(86417),_=l(85248);let g=class extends i.default{constructor(e){super(e),this.root=new f.M,this.state="disabled",this._loadLayers=(0,_.P)(),this.layers=new a.default}initialize(){this.addHandles(this.layers.on("change",(()=>this._onLayersChange()))),this._onLayersChange()}destroy(){this._set("state","disabled"),this.root.destroy()}set layers(e){const t=this._get("layers");this._set("layers",(0,n.V)(e,t))}_updateLayerTree(){this.root.destroy(),this._set("root",new f.M);const e=new Map,t=this.layers.length>1?"modelName":"id";return this.layers.forEach((l=>{const s=(0,c.tV)(l);this._addNodesForSublayers(s??l,this.root,e,t)})),this}_addNodeForLayer(e,t,l,s){const i=String(e[s]).toLowerCase();if(null==i||e.isEmpty)return;const a=`${t.id}/${i}`;let n=l.get(a);n||(n=new f.M({id:i,level:t.level+1}),l.set(a,n)),n.layers.push(e),t.children.push(n),this._addNodesForSublayers(e,n,l,s)}_addNodesForSublayers(e,t,l,s){("building-scene"===e.type||"building-group"===e.type&&!e.isEmpty)&&e.sublayers.forEach((e=>this._addNodeForLayer(e,t,l,s)))}async _onLayersChange(){if(this._set("state","loading"),0!==this.layers.length)try{await this._loadLayers(this.layers),this._updateLayerTree(),this._set("state","ready")}catch(e){(0,o.isAbortError)(e)||this._set("state","failed")}}};(0,s._)([(0,u.MZ)({readOnly:!0})],g.prototype,"root",void 0),(0,s._)([(0,u.MZ)({type:a.default,nonNullable:!0})],g.prototype,"layers",null),(0,s._)([(0,u.MZ)({readOnly:!0,nonNullable:!0})],g.prototype,"state",void 0),g=(0,s._)([(0,h.$)("esri.widgets.BuildingExplorer.BuildingDisciplinesViewModel")],g);const v=g;var m=l(50934),w=l(37407),b=l(36767);let M=class extends i.default{constructor(e){super(e),this.view=null,this.state="disabled",this.level=new m.default,this.phase=new w.default,this.disciplines=new v,this._loadLayers=(0,_.P)(),this.layers=new a.default}initialize(){this.addHandles([this.layers.on("change",(()=>this._onLayersChange())),(0,d.watch)((()=>({state:this.state,layers:this.layers,filter:this._filter})),(e=>{let{state:t,layers:l,filter:s}=e;"ready"===t&&(0,b.gK)(l,s)}),{initial:!0})]),this._onLayersChange()}destroy(){this.level.destroyed||this.level.destroy(),this.phase.destroyed||this.phase.destroy(),this.disciplines.destroyed||this.disciplines.destroy()}get isSupported(){return"3d"===this.view?.type}get layers(){return this._get("layers")}set layers(e){const t=e.filter((e=>e instanceof y.default));t.length!==e.length&&r.A.getLogger(this).error("Some layers are not BuildingSceneLayers but only BuildingSceneLayers can be passed to the widget."),this._set("layers",(0,n.V)(t,this._get("layers")))}get _filter(){const e=this.level.filterExpressions,t=this.phase.filterExpressions,l=[],s=(0,b.r$)([e.solid,t.solid]);null!=s&&l.push(s);const i=(0,b.wI)([e.xRay,t.xRay]);return null!=i&&l.push(i),0===l.length?null:new p.default({id:(0,b.Z4)(),name:"Building Explorer Filter",filterBlocks:l})}async _onLayersChange(){const e=this.layers;if(this.level.layers=e,this.phase.layers=e,this.disciplines.layers=e,0!==e.length){this._set("state","loading");try{await this._loadLayers(e),await Promise.all([(0,d.whenOnce)((()=>"ready"===this.level.state)),(0,d.whenOnce)((()=>"ready"===this.phase.state)),(0,d.whenOnce)((()=>"ready"===this.disciplines.state))]),e.forEach(c.Cb),this._set("state","ready")}catch(t){(0,o.isAbortError)(t)||this._set("state","failed")}}else this._set("state","disabled")}};(0,s._)([(0,u.MZ)({value:null})],M.prototype,"view",void 0),(0,s._)([(0,u.MZ)()],M.prototype,"isSupported",null),(0,s._)([(0,u.MZ)({type:a.default,nonNullable:!0})],M.prototype,"layers",null),(0,s._)([(0,u.MZ)({readOnly:!0})],M.prototype,"state",void 0),(0,s._)([(0,u.MZ)({readOnly:!0,type:m.default})],M.prototype,"level",void 0),(0,s._)([(0,u.MZ)({readOnly:!0,type:w.default})],M.prototype,"phase",void 0),(0,s._)([(0,u.MZ)({readOnly:!0,type:v})],M.prototype,"disciplines",void 0),(0,s._)([(0,u.MZ)()],M.prototype,"_filter",null),M=(0,s._)([(0,h.$)("esri.widgets.BuildingExplorer.BuildingExplorerViewModel")],M);const N=M},50934:(e,t,l)=>{l.r(t),l.d(t,{default:()=>h});var s=l(35143),i=l(46053),a=(l(81806),l(76460),l(47249),l(85842)),n=l(9559),r=l(78168),o=l(36767),d=l(91885);let u=class extends n.A{constructor(e){super(e),this._levelFieldName=null,this._parseValueFromFilter=e=>{const t=new RegExp(`${this._levelFieldName}\\s*=\\s*(\\d+)`,"gi"),l=new RegExp(`${this._levelFieldName}\\s*<\\s*(\\d+)`,"gi");for(const{filterMode:s,filterExpression:i}of e.filterBlocks?.items??[]){if(null==i)continue;let e=null;if("solid"===s.type?e=t.exec(i):"x-ray"===s.type&&(e=l.exec(i)),e)return parseInt(e[1],10)}return null}}get filterExpressions(){return this.enabled&&this._levelFieldName?{xRay:`${this._levelFieldName} < ${this.value}`,solid:`${this._levelFieldName} = ${this.value}`}:{solid:null,xRay:null}}get _firstValue(){const e=this.allowedValues;return e.length>0?e[0]:0}_setup(){const e=[];this.layers.forEach((t=>{const l=(0,r.BJ)(t,"bldglevel");null!=l&&(this._levelFieldName=l.fieldName,e.push(l))})),this._domainInfo=(0,d.$m)(e);const t=this._valueBeforeReady;this._set("state","ready"),this._valueBeforeReady=null;const l=t??(0,o.PE)(this.layers,this._parseValueFromFilter);null!=l?this.select(l):(this.enabled=!1,this.value=this._firstValue)}};(0,s._)([(0,i.MZ)({readOnly:!0})],u.prototype,"filterExpressions",null),(0,s._)([(0,i.MZ)()],u.prototype,"_levelFieldName",void 0),(0,s._)([(0,i.MZ)({readOnly:!0})],u.prototype,"_firstValue",null),u=(0,s._)([(0,a.$)("esri.widgets.BuildingExplorer.BuildingLevel")],u);const h=u},78168:(e,t,l)=>{l.d(t,{BJ:()=>r,Cb:()=>n,tV:()=>i});const s=e=>t=>{const l=e.toLowerCase();return t.sublayers.find((e=>e.modelName?.toLowerCase()===l))??null},i=s("fullmodel"),a=s("overview");function n(e){const t=i(e);null!=t&&(t.visible=!0);const l=a(e);null!=l&&(l.visible=!1)}function r(e,t){const l=function(e,t){const l=e.summaryStatistics?.fields??[],s=t.toLowerCase();return l.find((e=>e.modelName?.toLowerCase()===s))??null}(e,t);if(null==l)return null;const s=l.fieldName;if(null==s||!s)return null;const i=function(e,t){for(const l of e.allSublayers.items){const e="building-component"===l.type?l.getFieldDomain?.(t):null;if(e&&"coded-value"===e.type)return e}return null}(e,s),a=new Map;for(const n of l.mostFrequentValues??[])"number"==typeof n&&a.set(n,null!=i?i.getName(n):String(n));return{fieldName:s,fieldValueMap:a}}},85248:(e,t,l)=>{l.d(t,{P:()=>i});var s=l(50346);function i(){let e=new AbortController;return async t=>{e.abort(),e=new AbortController;const l={signal:e.signal},i=t.toArray().map((e=>async function(e,t){await e.load(t),await e.loadAll(),(0,s.throwIfAborted)(t),e.summaryStatistics&&await e.summaryStatistics.load(t)}(e,l)));await Promise.all(i),(0,s.throwIfAborted)(l)}}},86417:(e,t,l)=>{l.d(t,{M:()=>d});var s=l(35143),i=l(91967),a=l(19276),n=l(68134),r=l(46053),o=(l(81806),l(76460),l(47249),l(85842));let d=class extends i.default{constructor(e){super(e),this.id="root",this.parent=null,this.children=new a.default,this.layers=new a.default,this.level=0,this._childIds=new Set,this._layerUniqueIds=new Set}initialize(){this.addHandles([this.layers.on("before-add",(e=>{this._layerUniqueIds.has(e.item.uid)?e.preventDefault():this._layerUniqueIds.add(e.item.uid)})),this.layers.on("after-add",(e=>{let{item:t}=e;this.addHandles([(0,n.watch)((()=>t.visible),(()=>this.notifyChange("visible")),n.initial),(0,n.watch)((()=>t.title),(()=>this.notifyChange("title")),n.initial)],t.uid)})),this.layers.on("before-remove",(e=>{let{item:t}=e;this.removeHandles(t.uid),this.notifyChange("title"),this.notifyChange("visible")})),this.children.on("before-add",(e=>{this._childIds.has(e.item.id)?e.preventDefault():(e.item._set("parent",this),this._childIds.add(e.item.id))}))])}destroy(){this.children.forEach((e=>e.destroy()))}get hasChildren(){return this.children.length>0}get isDiscipline(){return 1===this.level}get visible(){return u(this.layers,(e=>e.visible))}get title(){return u(this.layers,(e=>e.title))||this.layers.items.map((e=>e.title)).join(", ")||null}toggleVisibility(e){const t=void 0===e?!this.visible:e;this.layers.forEach((e=>{e.visible=t})),t&&null!=this.parent&&this.parent.toggleVisibility(!0)}toggleAllSiblingsVisibility(e){const t=void 0===e?!this.visible:e;this.toggleVisibility(t),null!=this.parent&&(this.parent.toggleVisibility(t),this.parent.children.forEach((e=>e.toggleVisibility(t))))}};function u(e,t){let l=null;for(const s of e.items){const e=t(s);if(null!=l&&l!==e)return null;l=e}return l}(0,s._)([(0,r.MZ)({nonNullable:!0})],d.prototype,"id",void 0),(0,s._)([(0,r.MZ)()],d.prototype,"parent",void 0),(0,s._)([(0,r.MZ)({nonNullable:!0,readOnly:!0})],d.prototype,"children",void 0),(0,s._)([(0,r.MZ)({nonNullable:!0,readOnly:!0})],d.prototype,"layers",void 0),(0,s._)([(0,r.MZ)({nonNullable:!0})],d.prototype,"level",void 0),(0,s._)([(0,r.MZ)({readOnly:!0})],d.prototype,"hasChildren",null),(0,s._)([(0,r.MZ)({readOnly:!0})],d.prototype,"isDiscipline",null),(0,s._)([(0,r.MZ)({readOnly:!0})],d.prototype,"visible",null),(0,s._)([(0,r.MZ)({readOnly:!0})],d.prototype,"title",null),d=(0,s._)([(0,o.$)("esri.widgets.BuildingExplorer.support.LayerTreeNode")],d)},91885:(e,t,l)=>{function s(e){const t={fieldValueMap:new Map,allowedValues:[]};for(const l of e){const e=l.fieldValueMap,s=t.fieldValueMap;e.forEach(((e,l)=>{s.has(l)||(s.set(l,e),t.allowedValues.push(l))}))}return t.allowedValues.sort(((e,t)=>e-t)),t}function i(e){let t=null;for(const l of e)t=null!=t?Math.min(t,l):l;return t}function a(e){let t=null;for(const l of e)t=null!=t?Math.max(t,l):l;return t}function n(e,t){return t.allowedValues.length>0?function(e,t){if(0===t.length)return e;if(e===1/0)return t[t.length-1];if(e===-1/0)return t[0];let l=t[0],s=Math.abs(l-e);for(const i of t){const t=Math.abs(i-e);t<s&&(l=i,s=t)}return l}(e,t.allowedValues):null}l.d(t,{$m:()=>s,IM:()=>n,Lu:()=>a,pg:()=>i})}}]);
//# sourceMappingURL=39821.c5ba0c8e.chunk.js.map