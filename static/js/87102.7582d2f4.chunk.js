"use strict";(self.webpackChunktestapp=self.webpackChunktestapp||[]).push([[87102],{11742:(e,t,i)=>{i.r(t),i.d(t,{default:()=>y});var s=i(35143),n=i(5632),a=i(50346),o=i(68134),r=i(46053),l=(i(81806),i(76460),i(47249),i(85842)),u=i(19451),p=i(9912),d=i(48397),c=i(91039),h=i(26547);let f=class extends(n.A.IdentifiableMixin(d.A)){constructor(e){super(e),this.group=null,this.type="utilityNetworkAssociations",this.featureItem=null,this._updatingHandlesSetUp=new u.U,this.addHandles([(0,o.watch)((()=>({feature:this.feature,element:this.element,layer:this.layer})),(e=>this._createAssociationVM(e)),o.initial),(0,o.watch)((()=>this.feature),(()=>this._setFeatureItem())),(0,o.watch)((()=>this.associatedLayer),((e,t)=>this._updateLayerEditHandle(e,t)),o.initial)])}destroy(){this._associationsVM?.destroy(),this._updatingHandlesSetUp.destroy()}get activeAssociationType(){return this._associationsVM?.activeAssociationType}get associatedFeatures(){const{associatedLayer:e}=this;if(e)return this.associatedFeatureInfos.get(e)}get associatedFeatureInfos(){const{_associationsVM:e}=this;if(!e?.associationFeatures?.size||!e?.utilityNetwork)return new Map;const{associationFeatures:t}=e,i=new Map;return t.forEach(((e,t)=>{const s=e.map((e=>{if(null==e.title){const t=(0,h.R)(e.feature);return{...e,title:t}}return e}));i.set(t,s)})),i}get associatedLayer(){return this._get("associatedLayer")}set associatedLayer(e){this._associationsVM.showAllEnabled=null!=e,this._set("associatedLayer",e)}get associationsViewModel(){return this._associationsVM}get canAddAssociation(){const{editable:e,utilityNetwork:t}=this;return!(!t||!this.loaded)&&e}get editable(){return this.evaluatedEditableExpression??!0}get featureCount(){return this._associationsVM?.featureCount??0}get viewModel(){return this._associationsVM}get loaded(){return"loading"!==this._associationsVM?.state&&!this._updatingHandlesSetUp.updating}get map(){return this._get("map")}set map(e){e&&this._associationsVM?.set("map",e),this._set("map",e)}get utilityNetwork(){return this._associationsVM?.utilityNetwork}get associationTypes(){return this._associationsVM?.associationTypes??this.element.associationTypes}get visible(){const{utilityNetwork:e}=this;return!!e&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element)}get updating(){return"loading"===this._associationsVM?.state||"querying"===this._associationsVM?.state}async refresh(){await(0,a.ignoreAbortErrors)(this._associationsVM.refresh())}_updateLayerEditHandle(e,t){t&&"layerId"in t&&this.removeHandles(t?.layerId),(0,p.isAssociatedFeatureSupportedLayer)(e)&&this.addHandles((0,o.on)((()=>e),"edits",(()=>this.refresh())),e.layerId)}_createAssociationVM(e){const{feature:t,element:i,layer:s}=e;if(this._associationsVM?.destroy(),!t||!i||!s)return;const{map:n,associationTypes:a}=this;(0,p.isAssociatedFeatureSupportedLayer)(s)&&(this._associationsVM=new c.A({graphic:t,layer:s,map:n,associationTypes:a,source:"featureForm",title:this.label,description:this.description}))}_setFeatureItem(){this._updatingHandlesSetUp.addPromise((async()=>{const{feature:e,layer:t}=this;e&&t&&"getFeatureTitle"in t&&(this.featureItem={feature:e,label:await t.getFeatureTitle(e)})})())}};(0,s._)([(0,r.MZ)()],f.prototype,"_associationsVM",void 0),(0,s._)([(0,r.MZ)()],f.prototype,"activeAssociationType",null),(0,s._)([(0,r.MZ)()],f.prototype,"associatedFeatures",null),(0,s._)([(0,r.MZ)()],f.prototype,"associatedFeatureInfos",null),(0,s._)([(0,r.MZ)()],f.prototype,"associatedLayer",null),(0,s._)([(0,r.MZ)()],f.prototype,"associationsViewModel",null),(0,s._)([(0,r.MZ)()],f.prototype,"canAddAssociation",null),(0,s._)([(0,r.MZ)()],f.prototype,"editable",null),(0,s._)([(0,r.MZ)()],f.prototype,"featureCount",null),(0,s._)([(0,r.MZ)()],f.prototype,"viewModel",null),(0,s._)([(0,r.MZ)()],f.prototype,"group",void 0),(0,s._)([(0,r.MZ)()],f.prototype,"loaded",null),(0,s._)([(0,r.MZ)()],f.prototype,"map",null),(0,s._)([(0,r.MZ)()],f.prototype,"utilityNetwork",null),(0,s._)([(0,r.MZ)()],f.prototype,"associationTypes",null),(0,s._)([(0,r.MZ)({readOnly:!0})],f.prototype,"type",void 0),(0,s._)([(0,r.MZ)()],f.prototype,"visible",null),(0,s._)([(0,r.MZ)()],f.prototype,"updating",null),(0,s._)([(0,r.MZ)()],f.prototype,"featureItem",void 0),f=(0,s._)([(0,l.$)("esri.widgets.FeatureForm.UtilityNetworkAssociationInput")],f);const y=f},56166:(e,t,i)=>{i.r(t),i.d(t,{default:()=>x});var s=i(35143),n=i(19276),a=i(67993),o=i(60767),r=i(90632),l=i(46053),u=(i(81806),i(76460),i(47249),i(85842)),p=i(19451),d=i(53430),c=i(3320),h=i(84668);let f;const y=["blockquote","html","hr","checkbox","table","tablerow","tablecell","image"];async function _(){const{Marked:e}=await i.e(20096).then(i.bind(i,20096)),t=()=>"",s={};for(const i of y)s[i]=t;f=new e({renderer:{del:function(e){let{text:t}=e;return`<span style="text-decoration:line-through;">${t}</span>`},link:function(e){let{href:t,text:i,title:s}=e;return`<a${null!=t?` href="${t}"`:""}${null!=s?` title="${s}"`:""} target="_blank">${i??""}</a>`},...s}})}var m=i(76099);let g=class extends h.A{constructor(e){super(e),this.group=null,this.id=`TextElementInput-${(0,r.c)()}`,this.type="text",this._expressionReferences=new a.A,this._expressionsUsed=new o.A,this._fieldsUsed=new o.A,this._literalParts=new n.default,this._templateParts=new n.default,this._updatingHandles=new p.U}initialize(){const{rawText:e}=this;e?"markdown"===this.textFormat?this._updatingHandles.addPromise(async function(e){return f||await _(),f.parse(e)}(e).then((e=>this._initializeTextParts(e)))):this._initializeTextParts(e):this._literalParts.push("")}get expressionsUsed(){return Array.from(this._expressionsUsed)}get fieldsIndex(){return this.layer.fieldsIndex}set fieldsIndex(e){this._overrideIfSome("fieldsIndex",e)}get fieldsUsed(){return Array.from(this._fieldsUsed)}get rawText(){return this.element.text}get text(){const e=this._templateParts.map((e=>`${this._expressionReferences.get(e)?.lastEvaluatedValue??""}`));return m.W5.sanitize(function(e,t){return t.reduce(((t,i,s)=>t.concat(e.at(s),i)),"").concat(e.at(-1))}(this._literalParts,e))}get textFormat(){return this.element.textFormat}get updating(){return this._updatingHandles.updating||Array.from(this._expressionReferences.values()).some((e=>e?.updating))}setExpressionExecutor(e,t){this._expressionReferences.set((0,c.t6)(e),t)}setFieldExecutor(e,t){this._expressionReferences.set((0,c.H1)(e),t)}_initializeTextParts(e){const{fieldsIndex:t}=this,{literals:i,templates:s}=function(e){const t=[...e.matchAll(/{[^{]+?}/g)];let i=0;const s=[],n=[];for(const a of t){const t=a[0];s.push(e.slice(i,a.index)),n.push(t),i=a.index+t.length}return s.push(e.slice(i)),{literals:s,templates:n}}(e),n=[],a=[];for(let o=0;o<s.length;o++){const e=i[o],r=(0,d.extractSubstitutionTemplatesFromString)(s[o])[0];if((0,c.s9)(r))this._expressionsUsed.add((0,c.oc)(r)),this._expressionReferences.set(r,null),n.push(e),a.push(r);else if((0,c.qG)(r)){this._expressionsUsed.add(r);const t=(0,c.t6)(r);this._expressionReferences.set(t,null),n.push(e),a.push(t)}else if(t?.has(r)){const i=t.normalizeFieldName(r);this._fieldsUsed.add(i);const s=(0,c.H1)(i);this._expressionReferences.set(s,null),n.push(e),a.push(s)}else i[o+1]=e.concat(r,i[o+1])}n.push(i.at(-1)),this._literalParts.addMany(n),this._templateParts.addMany(a)}};(0,s._)([(0,l.MZ)()],g.prototype,"expressionsUsed",null),(0,s._)([(0,l.MZ)()],g.prototype,"fieldsIndex",null),(0,s._)([(0,l.MZ)()],g.prototype,"fieldsUsed",null),(0,s._)([(0,l.MZ)()],g.prototype,"group",void 0),(0,s._)([(0,l.MZ)()],g.prototype,"id",void 0),(0,s._)([(0,l.MZ)()],g.prototype,"rawText",null),(0,s._)([(0,l.MZ)()],g.prototype,"text",null),(0,s._)([(0,l.MZ)()],g.prototype,"textFormat",null),(0,s._)([(0,l.MZ)()],g.prototype,"type",void 0),(0,s._)([(0,l.MZ)()],g.prototype,"updating",null),g=(0,s._)([(0,u.$)("esri.widgets.FeatureForm.TextElementInput")],g);const x=g},59708:(e,t,i)=>{i.r(t),i.d(t,{default:()=>d});var s=i(35143),n=i(68134),a=i(90632),o=i(46053),r=(i(81806),i(76460),i(47249),i(85842)),l=i(3320),u=i(84668);let p=class extends u.A{constructor(e){super(e),this._expressionTrackingHandles=new Map,this.id=(0,a.c)().toString(),this.type="group"}initialize(){this.addHandles([(0,n.watch)((()=>[this.visible,this.inputs]),(e=>{let[t]=e;const{inputs:i}=this,s=!!t&&void 0;for(const n of i)(0,l.rf)(n)&&(n.required=s)}),{initial:!0,equals:(e,t)=>t[0]===e[0]&&t[1]===e[1]})])}destroy(){for(const e of this._expressionTrackingHandles.values())e.remove()}get initialState(){return this.element.initialState||"expanded"}get inputs(){return this._get("inputs")}set inputs(e){this.removeAllHandles(),e&&this.addHandles(e.map((e=>(0,n.watch)((()=>e.visible),(()=>this._dirtyEvaluatedVisibilityExpression()))))),this._set("inputs",e)}get open(){return"expanded"===this.initialState}set open(e){this._override("open",e)}get visible(){return!1!==this.evaluatedVisibilityExpression&&this.inputs&&this.inputs.some((e=>e.visible))}_dirtyEvaluatedVisibilityExpression(){const{element:e}=this;e.visibilityExpression&&this.notifyChange("evaluatedVisibilityExpression")}};(0,s._)([(0,o.MZ)()],p.prototype,"id",void 0),(0,s._)([(0,o.MZ)()],p.prototype,"initialState",null),(0,s._)([(0,o.MZ)()],p.prototype,"inputs",null),(0,s._)([(0,o.MZ)()],p.prototype,"open",null),(0,s._)([(0,o.MZ)()],p.prototype,"type",void 0),(0,s._)([(0,o.MZ)()],p.prototype,"visible",null),p=(0,s._)([(0,r.$)("esri.widgets.FeatureForm.GroupInput")],p);const d=p},60767:(e,t,i)=>{i.d(t,{A:()=>a});var s=i(99486),n=i(99702);class a{constructor(e){this._observable=new n.I,this._set=new Set(e)}get size(){return(0,s.gc)(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return(0,s.gc)(this._observable),this._set.entries()}forEach(e,t){(0,s.gc)(this._observable),this._set.forEach(((i,s)=>e.call(t,i,s,this)),t)}has(e){return(0,s.gc)(this._observable),this._set.has(e)}keys(){return(0,s.gc)(this._observable),this._set.keys()}values(){return(0,s.gc)(this._observable),this._set.values()}[Symbol.iterator](){return(0,s.gc)(this._observable),this._set[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}},65529:(e,t,i)=>{i.r(t),i.d(t,{default:()=>g});var s=i(35143),n=i(50076),a=i(68134),o=i(46053),r=(i(81806),i(76460),i(47249),i(85842)),l=i(15142),u=i(53430),p=i(42633),d=i(85632),c=i(9912),h=i(48397),f=i(3320),y=i(20639),_=i(23301);let m=class extends h.A{constructor(e){super(e),this._storedValue=null,this.error=null,this.preservesValueWhenHidden=!0,this.field=null,this.group=null,this.requiredExpressionExecutor=null,this.type="field",this._fieldInputWasVisibleDuringLifetime=!1,this.valueExpressionExecutor=null}initialize(){this.addHandles((0,a.watch)((()=>this.feature),(()=>this._fieldInputWasVisibleDuringLifetime=!1),a.sync))}get _dateFormRange(){const{element:e,field:t}=this;if("date"!==this.dataType)return{};const i=e?.domain?(0,l.A5)(t,e.domain):null;if(!e?.input)return i??{};const s=e.input,{type:n}=s;let a={};if("date-picker"!==n&&"time-picker"!==n&&"datetimeoffset-picker"!==n||(a=(0,l.nm)(t,s.max,s.min)),"datetime-picker"===n){const{max:e,min:t}=s;a={max:null!=e&&(0,_.$$)(e)?e.getTime():null,min:null!=t&&(0,_.$$)(t)?t.getTime():null}}const{max:o,min:r}=a;if(i){const{max:e,min:t}=i,s=(0,d.Et)(e)&&(null==o||null!=o&&e<o),n=(0,d.Et)(t)&&(null==r||null!=r&&t>r);return{max:s?e:o??null,min:n?t:r??null,rawMax:s?i.rawMax:a?.rawMax??null,rawMin:n?i.rawMin:a?.rawMin??null}}return{min:r,max:o,rawMax:a?.rawMax??null,rawMin:a?.rawMin??null}}get _dateRange(){const{_dateFormRange:e,field:t}=this;if("date"!==this.dataType)return{};const i=(0,l.A5)(t);if(!i)return e;const{max:s,min:n,rawMax:a,rawMin:o}=e;if("date"===t.type){const{max:e,min:t}=i;return{max:(0,d.Et)(s)&&(null===e||null!=e&&s<e)?s:e??null,min:(0,d.Et)(n)&&(null===t||null!=t&&n>t)?n:t??null}}if("date-only"===t.type||"time-only"===t.type||"timestamp-offset"===t.type){const{max:e,min:t,rawMax:r,rawMin:l}=i,u=(0,d.Et)(s)&&a&&(null==e||s<e),p=(0,d.Et)(n)&&o&&(null==t||n>t);return{max:u?s:e,min:p?n:t,rawMax:u?a:r,rawMin:p?o:l}}return{max:null,min:null}}get _configAllowsEdits(){const{element:e,layer:t,name:i}=this;if(null!=e)return e.editableExpression?!!this.evaluatedEditableExpression:!1!==e.editable;if(t?.userHasUpdateItemPrivileges)return!0;const s=t&&"popupTemplate"in t?t?.popupTemplate?.fieldInfos?.find((e=>{let{fieldName:t}=e;return t===i})):null;return s?.isEditable??!0}get _layerAndFieldAllowEdits(){return this.layerAllowsEdits&&this.field?.editable}get _isVisibleByDefault(){const{field:e,layer:t}=this;return!!e?.visible&&(0,u.isFieldVisibleByDefault)(e,t)}get _isEditTrackingField(){return(0,u.getLowerCaseEditTrackingFields)(this.layer).includes(this.name?.toLowerCase())}get _shouldUseValueExpression(){return this._layerAndFieldAllowEdits&&!this._configAllowsEdits&&null!=this.valueExpressionExecutor&&this.valueExpressionExecutor.initialExecutionComplete}get isSubtypeField(){const{layer:e}=this;if(e&&"subtypeField"in e){const{subtypeField:t,fieldsIndex:i}=e;return(i.get(t)?.name??t)===this.name}return!1}get valueIsOutOfDomain(){const{domain:e,value:t,field:i}=this;return!(!e||null==t)&&null!==(0,l.wb)(i,t,e)}get dataType(){const{field:e}=this;return(0,u.isNumericField)(e)?_.Kx.Number:(0,u.isStringField)(e)?_.Kx.Text:(0,p.fs)(e)||(0,u.isTimeOnlyField)(e)?_.Kx.Date:_.Kx.Unsupported}get dateDataType(){if(this.dataType===_.Kx.Date)return"date"!==this.field.type?"string":"number"}get domain(){const{layer:e,feature:t,name:i,element:s}=this,n=s?.domain;return null!=n&&this._isDomainCompatible(n)?n:e.getFieldDomain(i,{feature:t})}get editable(){return!!this._layerAndFieldAllowEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}get evaluatedRequiredExpression(){const{requiredExpressionExecutor:e}=this;return null!=e?!!e.lastEvaluatedValue:null}get evaluatedValueExpression(){const{valueExpressionExecutor:e}=this;return null!=e?e.lastEvaluatedValue:null}get hint(){return this.element?.hint}get includeDate(){return!(this.dataType!==_.Kx.Date||"time-only"===this.field.type)}get includeTime(){const{element:e,field:t}=this;if(this.dataType!==_.Kx.Date)return!1;if("time-only"===t.type)return!0;if("date-only"===t.type)return!1;const i="datetime-picker"===e?.input?.type?e.input.includeTime:void 0;return void 0===i||i}get includeTimeOffset(){if("timestamp-offset"!==this.field.type)return!1;const e=this.element?.input;return!e||"datetimeoffset-picker"===e.type&&e.includeTimeOffset}set initialFeature(e){this._set("initialFeature",e),this.notifyChange("valid")}get inputType(){return this.element?.input?.type}get hasInvalidSwitchValue(){const{element:e}=this,t=(0,f.HG)(e,"switch")?e.input:null;return!t||(0,f.Kn)(this.value,t)}get isRelationshipKeyField(){const{field:e,layer:t}=this;return(0,c.isRelatableFeatureSupportedLayer)(t)&&!!t.relationships?.some((t=>t.keyField===e.name))}get label(){const{field:e}=this;return this.getFormattedLabel(this.element?.label)??e.alias??e.name}get maxLength(){return(0,_.zU)({dataType:this.dataType,field:this.field,input:this.element?.input})}get minLength(){return(0,_.jl)({dataType:this.dataType,field:this.field,input:this.element?.input})}get name(){return this.field?.name}get range(){const{domain:e,element:t,field:i}=this;if("date"===this.dataType)return this._dateRange;const s=(0,l.A5)(i,e)||(0,u.getFieldRange)(i,e),n=s?.max===Number.MAX_VALUE?null:s?.max??null,a=s?.min===-Number.MAX_VALUE?null:s?.min??null;if(!t?.domain||"range"!==t.domain.type)return{max:n,min:a};const{max:o,min:r}=(0,l.A5)(i)||{};return{max:null!=o&&(null===n||null!=n&&o<n)?o:n,min:null!=r&&(null===a||null!=a&&r>a)?r:a}}get required(){const{editable:e,evaluatedRequiredExpression:t,field:i,visible:s,isSubtypeField:n}=this;return!!e&&(!1===i?.nullable||(!!n||!(!s||!1===this.group?.visible||null==t)&&t))}set required(e){this._overrideIfSome("required",e)}get showNoValueOptionEnabled(){const{element:e}=this;return!this.required&&(!(0,f.XI)(e)||e.input.showNoValueOption)}get showNoValueLabel(){const{element:e}=this;return(0,f.XI)(e)?e.input.noValueOptionLabel:null}get submittable(){const{field:e,required:t,valid:i,value:s}=this;return(!t||null!=s)&&(!!i||this.initialFeature.getAttribute(e.name)===s)}get timeResolution(){const e=this.element?.input;if(e&&("datetimeoffset-picker"===e.type||"time-picker"===e.type))return e.timeResolution??"minutes"}get timeStep(){return null!=this.timeResolution?y.fl.get(this.timeResolution):void 0}get updating(){const{editableExpressionExecutor:e,valueExpressionExecutor:t,visibilityExpressionExecutor:i,preservesValueWhenHidden:s}=this;return null!=t&&t.updating||null!=e&&e.updating||!1===s&&null!=i&&i.updating}get valid(){const e=this.editable?this._validate():null;return this._set("error",e),null===e}get value(){if(this._fieldInputWasVisibleDuringLifetime=this._fieldInputWasVisibleDuringLifetime||this.visible&&!1!==this.group?.visible,!1===this.preservesValueWhenHidden&&this._fieldInputWasVisibleDuringLifetime&&(!1===this.visibilityExpressionExecutor?.lastEvaluatedValue||!1===this.group?.visibilityExpressionExecutor?.lastEvaluatedValue))return null!==this._storedValue&&this.set("_storedValue",null),null;if(this._shouldUseValueExpression){const e=this.evaluatedValueExpression;return this.dataType===_.Kx.Date?this._arcadeOutputToDateFieldValue(e):null!=e&&"object"==typeof e?`${e}`:e}return this._storedValue}set value(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e),this.notifyChange("value"),this.notifyChange("valid")}get visible(){return!this._isEditTrackingField&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element&&!1!==this.field?.visible||this._isVisibleByDefault)}_arcadeOutputToDateFieldValue(e){const t=this.field.type;try{if("object"==typeof e){if(null===e)return null;if((0,y.rX)(e))return(0,y.fD)(e,t);if("getTime"in e&&"function"==typeof e.getTime&&"date"===t)return parseInt(e.getTime(),10);if("date-only"===t||"time-only"===t||"timestamp-offset"===t)return e.toString()}else{if("string"==typeof e)return"date"===t?parseInt(e,10):e;if("number"==typeof e&&"date"===t)return e}throw new n.default("feature-form:invalid-date-value")}catch{return"date"===t?NaN:""}}_isDomainCompatible(e){const{field:t}=this;if("coded-value"===e?.type){const i=typeof e.codedValues[0].code;if("string"===i&&(0,u.isStringField)(t)||"number"===i&&(0,u.isNumericField)(t))return!0}return!!("range"===e?.type&&(0,u.isNumericField)(t)||(0,p.fs)(t)||(0,u.isTimeOnlyField)(t))}_validate(){const{dataType:e,domain:t,field:i,minLength:s,range:n,required:a,value:o,maxLength:r}=this;return(0,_.Gd)(o,{dataType:e,domain:t,field:i,maxLength:r,minLength:s,range:n,required:a})}};(0,s._)([(0,o.MZ)()],m.prototype,"_dateFormRange",null),(0,s._)([(0,o.MZ)()],m.prototype,"_dateRange",null),(0,s._)([(0,o.MZ)()],m.prototype,"_storedValue",void 0),(0,s._)([(0,o.MZ)()],m.prototype,"_configAllowsEdits",null),(0,s._)([(0,o.MZ)()],m.prototype,"_layerAndFieldAllowEdits",null),(0,s._)([(0,o.MZ)()],m.prototype,"_isVisibleByDefault",null),(0,s._)([(0,o.MZ)()],m.prototype,"_isEditTrackingField",null),(0,s._)([(0,o.MZ)()],m.prototype,"_shouldUseValueExpression",null),(0,s._)([(0,o.MZ)()],m.prototype,"isSubtypeField",null),(0,s._)([(0,o.MZ)()],m.prototype,"valueIsOutOfDomain",null),(0,s._)([(0,o.MZ)()],m.prototype,"dataType",null),(0,s._)([(0,o.MZ)()],m.prototype,"dateDataType",null),(0,s._)([(0,o.MZ)()],m.prototype,"domain",null),(0,s._)([(0,o.MZ)()],m.prototype,"editable",null),(0,s._)([(0,o.MZ)({readOnly:!0})],m.prototype,"error",void 0),(0,s._)([(0,o.MZ)({constructOnly:!0})],m.prototype,"preservesValueWhenHidden",void 0),(0,s._)([(0,o.MZ)()],m.prototype,"evaluatedRequiredExpression",null),(0,s._)([(0,o.MZ)()],m.prototype,"evaluatedValueExpression",null),(0,s._)([(0,o.MZ)()],m.prototype,"field",void 0),(0,s._)([(0,o.MZ)()],m.prototype,"group",void 0),(0,s._)([(0,o.MZ)({readOnly:!0})],m.prototype,"hint",null),(0,s._)([(0,o.MZ)()],m.prototype,"includeDate",null),(0,s._)([(0,o.MZ)()],m.prototype,"includeTime",null),(0,s._)([(0,o.MZ)()],m.prototype,"includeTimeOffset",null),(0,s._)([(0,o.MZ)()],m.prototype,"initialFeature",null),(0,s._)([(0,o.MZ)({readOnly:!0})],m.prototype,"inputType",null),(0,s._)([(0,o.MZ)()],m.prototype,"hasInvalidSwitchValue",null),(0,s._)([(0,o.MZ)()],m.prototype,"isRelationshipKeyField",null),(0,s._)([(0,o.MZ)()],m.prototype,"label",null),(0,s._)([(0,o.MZ)()],m.prototype,"maxLength",null),(0,s._)([(0,o.MZ)()],m.prototype,"minLength",null),(0,s._)([(0,o.MZ)({readOnly:!0})],m.prototype,"name",null),(0,s._)([(0,o.MZ)()],m.prototype,"range",null),(0,s._)([(0,o.MZ)()],m.prototype,"required",null),(0,s._)([(0,o.MZ)()],m.prototype,"requiredExpressionExecutor",void 0),(0,s._)([(0,o.MZ)()],m.prototype,"showNoValueOptionEnabled",null),(0,s._)([(0,o.MZ)()],m.prototype,"submittable",null),(0,s._)([(0,o.MZ)()],m.prototype,"timeResolution",null),(0,s._)([(0,o.MZ)()],m.prototype,"timeStep",null),(0,s._)([(0,o.MZ)({readOnly:!0})],m.prototype,"type",void 0),(0,s._)([(0,o.MZ)()],m.prototype,"updating",null),(0,s._)([(0,o.MZ)()],m.prototype,"valid",null),(0,s._)([(0,o.MZ)({value:null})],m.prototype,"value",null),(0,s._)([(0,o.MZ)()],m.prototype,"valueExpressionExecutor",void 0),(0,s._)([(0,o.MZ)()],m.prototype,"visible",null),m=(0,s._)([(0,r.$)("esri.widgets.FeatureForm.FieldInput")],m);const g=m},87102:(e,t,i)=>{i.r(t),i.d(t,{default:()=>G});var s=i(35143),n=i(39356),a=i(4212),o=i(54099),r=i(76460),l=i(30726),u=i(91291),p=i(50346),d=i(68134),c=i(88685),h=i(46053),f=(i(47249),i(85842)),y=i(19451),_=i(80731),m=i(71764),g=i(41033),x=i(70445),v=i(16251),E=i(36693),b=i(3320),M=i(65529),w=i(91967),I=(i(81806),i(87663));const Z="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY";let F=class extends w.default{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this.preserveFieldValuesWhenHidden=!0,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}destroy(){this.resetExecutors()}get _asyncExecutors(){return this.executors.filter((e=>e.isAsync))}get _baseContext(){const{editType:e,layer:t,map:i,originalFeature:s,spatialReference:n,timeZone:a}=this.arcadeContextInfo,o="scene"===t?.type&&null!=t.associatedLayer?t.associatedLayer:t;return[{$originalfeature:s,$editcontext:{editType:e},$layer:o,$featureset:o,$datastore:t?.url,$map:i},{rawOutput:!0,spatialReference:n??void 0,timeZone:a}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateAsyncExpressions(){return this._evaluate(this._asyncExecutors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:i,feature:s}=this,n=new Set;for(const a of e)if(i[a]=s.getAttribute(a),t.has(a))for(const e of t.get(a))n.add(e);return this._evaluate([...n])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(Z))return this._evaluate([...this._fieldReferencesLookup.get(Z)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:i,preserveFieldValuesWhenHidden:s}=this,n=new Map(this.fieldInputs.map((e=>[e.name,e]))),a=!1===s,o=new Map(i.map((e=>[e,new Array])));for(const r of i){for(const i of r.fieldsUsed){(0,I.tE)(e,i,(()=>new Set)).add(r);const s=n.get(i);[s?.valueExpressionExecutor,s?.editableExpressionExecutor,a?s?.group?.visibilityExpressionExecutor:null,a?s?.visibilityExpressionExecutor:null].filter((e=>null!=e&&e!==r)).forEach((e=>{o.get(e).push(r),(0,I.tE)(t,e,(()=>new Set)).add(s)}))}r.geometryUsed&&(0,I.tE)(e,Z,(()=>new Set)).add(r)}return o}async _evaluate(e){const t=new Map,{_dependencyGraph:i,_fieldsAffectedLookup:s,_latestFieldValues:n}=this;for(const o of e)V(o,t,i);for(const[o,{resolver:r,dependencyPromises:l}]of t)Promise.all(l).then((async()=>{const[e,t]=this._makeContext(n);return o.executeAsync(e,t)})).then((()=>{if(s.has(o))for(const e of s.get(o))this._latestFieldValues[e.name]=e.value;r.resolve()}),(e=>{!e||(0,p.isAbortError)(e)||A(e)||o.markStale(),r.reject(e)}));const a=(await Promise.allSettled(Array.from(t.values(),(e=>{let{resolver:t}=e;return t.promise})))).filter((e=>"rejected"===e.status&&!((0,p.isAbortError)(e.reason)||A(e.reason))));if(a.length>0){const e=new AggregateError(a,`One or more expression executions failed. First error message: ${a[0].reason}`);throw r.A.getLogger(this).error(e),e}}_makeContext(e){const[t,i]=this._baseContext,s=this.feature.clone();return s.attributes=e,[{...t,$feature:s},i]}get test(){}};(0,s._)([(0,h.MZ)()],F.prototype,"_asyncExecutors",null),(0,s._)([(0,h.MZ)()],F.prototype,"_baseContext",null),(0,s._)([(0,h.MZ)()],F.prototype,"feature",null),(0,s._)([(0,h.MZ)({constructOnly:!0})],F.prototype,"preserveFieldValuesWhenHidden",void 0),(0,s._)([(0,h.MZ)()],F.prototype,"executors",void 0),(0,s._)([(0,h.MZ)()],F.prototype,"fieldInputs",void 0),(0,s._)([(0,h.MZ)()],F.prototype,"arcadeContextInfo",void 0),F=(0,s._)([(0,f.$)("esri.widgets.FeatureForm.FormExpressionsManager")],F);const V=(e,t,i)=>{if(t.has(e))return;const s=(0,p.createResolver)();t.set(e,{resolver:s,dependencyPromises:[]}),e.abort();const n=i.get(e);for(const a of n)V(a,t,i),t.get(a).dependencyPromises.push(s.promise)},A=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message;var C,T=i(59708),k=i(44575),S=i(56166),L=i(11742),R=i(30550),U=i(53430);const N=Symbol("FormExpressionArcadeExecutor");let H=class extends w.default{constructor(e){super(e),this[C]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._initialExecutionComplete=!1,this._stale=!1,this._updatingTracking=new y.U,this._executeAsyncDebounced=(0,p.debounce)((async(e,t,i)=>{const s=await this.executor.executeAsync(e,{...t,abortSignal:i});return i.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=s,this._stale=!1,s)}))}get initialExecutionComplete(){return this._initialExecutionComplete}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(e,t){this._abortController=new AbortController;const i=this.executor.execute(e,{...t,abortSignal:this._abortController.signal});return this._lastEvaluatedValue=i,this._initialExecutionComplete=!0,i}async executeAsync(e,t){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(e,t??{},this._abortController.signal).then((()=>{this._initialExecutionComplete=!0})))}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};C=N,(0,s._)([(0,h.MZ)()],H.prototype,"_lastEvaluatedValue",void 0),(0,s._)([(0,h.MZ)()],H.prototype,"_initialExecutionComplete",void 0),(0,s._)([(0,h.MZ)()],H.prototype,"_stale",void 0),(0,s._)([(0,h.MZ)()],H.prototype,"_updatingTracking",void 0),(0,s._)([(0,h.MZ)({constructOnly:!0})],H.prototype,"executor",void 0),(0,s._)([(0,h.MZ)()],H.prototype,"initialExecutionComplete",null),(0,s._)([(0,h.MZ)()],H.prototype,"isAsync",null),(0,s._)([(0,h.MZ)()],H.prototype,"fieldsUsed",null),(0,s._)([(0,h.MZ)()],H.prototype,"syntaxTree",null),(0,s._)([(0,h.MZ)()],H.prototype,"updating",null),(0,s._)([(0,h.MZ)()],H.prototype,"stale",null),(0,s._)([(0,h.MZ)()],H.prototype,"geometryUsed",null),(0,s._)([(0,h.MZ)()],H.prototype,"variablesUsed",null),(0,s._)([(0,h.MZ)()],H.prototype,"lastEvaluatedValue",null),H=(0,s._)([(0,f.$)("esri.widgets.support.forms.expressions.FormExpressionArcadeExecutor")],H);const O=new n.default({attributes:{}}),D={field:["editableExpression","requiredExpression","valueExpression","visibilityExpression"],group:["visibilityExpression"],relationship:["editableExpression","visibilityExpression"],text:["visibilityExpression"],utilityNetworkAssociations:["editableExpression","visibilityExpression"]},j="#JSAPI_CONTINGENT_VALUE_ANY_HASH",$="esri.widgets.FeatureForm.FeatureFormViewModel",P=()=>r.A.getLogger($);let W=class extends(u.A.EsriPromiseMixin(o.A.EventedAccessor)){constructor(e){super(e),this._expressionExecutorsInUse=new Set,this._expressionExecutorLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=O.clone(),this._initialFeature=O.clone(),this._timeZone=null,this._updatingHandles=new y.U,this.activeAssociation=null,this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.disabled=!1,this.highlightHelper=null,this.inputs=[],this.map=null,this.callbacks=null,this.strict=!1,this.pendingSubtypeChoice=null,this._updateInputs=(0,p.debounce)((async()=>{this._stopExpressions();const{_featureClone:e,_initialFeature:t,arcadeEditType:i,formTemplate:s,inputs:n,layer:a,timeZone:o}=this;if(!a)return;const r={arcadeEditType:i,feature:e,initialFeature:t,layer:a,timeZone:o},l=n.slice(),u=s?.elements&&s.elements.length>0?await this._updateInputsUsingFormElements(l,s.elements,r):this._updateInputsUsingLayerFields(l,a?.fields,r);this.inputs=u,await this._startExpressions()}))}initialize(){const e=(0,d.watch)((()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.timeZone,this.arcadeEditType]),(e=>{let[t,i]=e;null!=t&&(i?this._updatingHandles.addPromise(this._updateInputs()):t.load().catch((()=>{})))}),d.syncAndInitial),t=(0,d.watch)((()=>this._arcadeContextInfo),(e=>{null!=this._expressionsManager&&(this._expressionsManager.arcadeContextInfo=e,this._updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated()))))})),i=(0,d.watch)((()=>this.layer),(e=>{const t="subtype-sublayer"===e?.type?e.parent:"feature"===e?.type?e:null;t&&this.addResolvingPromise(v.A.createLoadedLayerContingentValuesCache(t).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0});this.addHandles([e,t,i])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=(0,l.pR)(this._contingentValuesCache),this.highlightHelper?.removeAll(),this._updatingHandles.destroy()}get _expressionInfosLookup(){return new Map(this.formTemplate?.expressionInfos?.map((e=>[e.name,e])))}get activeAssociationInput(){return this.allAssociationInputs.find((e=>e.uid===this.associationId))}get activeRelationshipInput(){return this.allRelationshipInputs.find((e=>e.relationshipId===this.relationshipId||e.activeCategory||e.showAllEnabled))}get _arcadeContextInfo(){const{_initialFeature:e,arcadeEditType:t,layer:i,map:s,spatialReference:n,timeZone:a}=this;return{layer:(0,x.S)(i)?i:null,originalFeature:e,editType:t,map:s,spatialReference:n,timeZone:a}}get associationId(){return this._get("associationId")}set associationId(e){null==e&&this.activeAssociationInput?.viewModel&&(this.activeAssociationInput.associatedLayer=null,this.activeAssociationInput.viewModel.activeAssociationType=null),this._set("associationId",e)}get associatedLayer(){return this.activeAssociationInput?.associatedLayer}set associatedLayer(e){this.activeAssociationInput&&(this.activeAssociationInput.associatedLayer=e)}get allAssociationInputs(){return(0,b.TN)(this.inputs)}get allFieldInputs(){return(0,b.Iy)(this.inputs)}get allGroupInputs(){return this.inputs.filter(b.Et)}get allRelationshipInputs(){return(0,b.cU)(this.inputs)}get _layerFieldsByName(){return new Map(this.layer?.fields.map((e=>[e.name,e])))}get feature(){return this._get("feature")}set feature(e){const t=this._get("feature");this._featureClone=e?e.clone():O.clone(),this._initialFeature=this._featureClone.clone(),this._expressionsManager&&(this._expressionsManager.feature=this._featureClone),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach((t=>t.feature=e))):(this.inputs.forEach((e=>e.destroy())),this.inputs.length=0),t!==e&&(this.pendingSubtypeChoice=null),this.contingencyConstraintViolations.clear(),this._set("feature",e)}get fieldsWithContingentValues(){if(null==this._contingentValuesCache)return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){const{formTemplate:e,layer:t}=this;return e?.description&&t?(0,b.LZ)({label:e.description,attributes:this.getValues(),fieldsIndex:t.fieldsIndex,timeZone:this.timeZone}):null}get formTitle(){const{formTemplate:e,layer:t}=this;return e?.title&&t?(0,b.LZ)({label:e.title,attributes:this.getValues(),fieldsIndex:t.fieldsIndex,timeZone:this.timeZone}):null}get formHeaderVisible(){const{activeRelationshipInput:e,activeAssociationInput:t,formDescription:i,formTitle:s}=this;return!(e||t||!i&&!s)}get joinedContingentValues(){return this._joinContingentValues()}get layer(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get relationshipId(){return this._get("relationshipId")}set relationshipId(e){const t=this.allRelationshipInputs;if(null!=e&&e===this.relationshipId||t.forEach((e=>{e.showAllEnabled=!1,e.activeCategory=null})),null!=e){const i=t.find((t=>t.relationshipId===e));i&&(i.showAllEnabled=!0)}this._set("relationshipId",e)}get spatialReference(){return this.layer?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){return this.layer?.loaded?"ready":"disabled"}get submittable(){return!!this.valid||this.allFieldInputs.filter((e=>!e.valid)).every((e=>{let{submittable:t}=e;return t}))}get timeZone(){const{layer:e}=this;if(e&&"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone)return E.n$;const t=e&&"preferredTimeZone"in e&&e.preferredTimeZone;return this._timeZone===E.L5?t||E.n$:this._timeZone||E.qU}set timeZone(e){this._timeZone=e}get updating(){return this._updatingHandles.updating}get valid(){const e=this.allFieldInputs;return e.length>0&&e.every((e=>{let{valid:t}=e;return t}))}findField(e){return this.allFieldInputs.find((t=>t.name===e))}getFieldValueOptionsForField(e,t){const i=this.findField(e);if(!i)return[[],[],[]];const s="coded-value"===i.domain?.type?i.domain.codedValues.map((e=>{let{name:t,code:i}=e;return{name:t,value:i}})):[],n=null==i.value||s.some((e=>e.value===i.value))?[]:[{name:`${i.value}`,value:i.value}],a=this.fieldsWithContingentValues.has(e)?this._getContingentValueOptionsForField(e,t):[];if(a.length>0){const e=new Set(a.map((e=>e.value)));return[a,s.filter((t=>!e.has(t.value))),n]}return[s,[],n]}getValue(e){const t=this.layer?.getField(e);if(null!=t)return this._featureClone.getAttribute(t.name)??null}setValue(e,t){const{_featureClone:i,strict:s}=this,n=this.findField(e);t=""===t?null:t,n&&i.getAttribute(e)!==t&&(n.value=t,s&&!n.valid||(this._afterValueChange(n),null!=this._expressionsManager&&this._updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([n.name]).finally((()=>this._afterExpressionsEvaluated())))))}getValues(){return{...this._featureClone.attributes}}overrideInitialFeature(e){this._initialFeature=e}submit(){const e=this.allFieldInputs,t=new Set(e.filter((e=>e.valid)).map((e=>{let{name:t}=e;return t}))),i=e.filter((e=>!e.valid)).map((e=>{let{name:t}=e;return t})),s=this.getValues();if(this.validateContingencyConstraints(s,{includeIncompleteViolations:!0}).length>0)for(const[n,a]of this.contingencyConstraintViolations.entries())"error"===a.type&&(t.delete(n),i.push(n));this.notifyChange("submittable"),this.notifyChange("valid"),this.emit("submit",{valid:[...t],invalid:i,values:s})}validateContingencyConstraints(e,t){const{_contingentValuesCache:i}=this,s=new Map;if(this.contingencyConstraintViolations=s,null==i)return[];const{invalid:n,incomplete:a}=i.validateContingencyConstraints(e),o=[...n,...t?.includeIncompleteViolations?a:[]];for(const r of o)for(const e of r.fieldGroup.fields)s.set(e,r);return o}notifyFeatureGeometryChanged(){const{_expressionsManager:e,feature:t,_featureClone:i}=this;t&&(i.geometry=t.geometry,null!=e&&this._updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally((()=>this._afterExpressionsEvaluated()))))}applySubtypeDefaults(e){const{defaultValues:t}=e,{allFieldInputs:i}=this;for(const{name:s}of i){const e=t[s];null!=e&&this.setValue(s,e)}}_emitChangeEvent(e){let{name:t,valid:i,value:s}=e;this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:t,value:s,valid:i})}async _updateInputsUsingFormElements(e,t,i){const s=new Map;for(const o of e)if((0,b.Et)(o)){s.set(o.element,o);for(const e of o.inputs)e.element&&s.set(e.element,e)}else o.element&&s.set(o.element,o);const n=new Map,a=await this._updateInputsUsingFormElementsRecursive({existingInputsByElement:s,updatedElements:t.filter(z),sharedInitializationProperties:i,group:null,newExpressionExecutorPromises:n});for(const[o,r]of s.entries())s.delete(o),r.destroy();return await Promise.all(Array.from(n.values())),a}async _updateInputsUsingFormElementsRecursive(e){const{existingInputsByElement:t,updatedElements:i,sharedInitializationProperties:s,group:n,newExpressionExecutorPromises:a}=e,o=[];for(const r of i){const e=t.has(r),i=e?t.get(r):this._makeInputFromElement(r,s,n);if(i){if(o.push(i),await(0,d.whenOnce)((()=>!i.updating)),this._assignExpressionExecutors(i,r,a),e)if(t.delete(r),(0,b.Et)(i)){const{feature:e,timeZone:t}=s;i.set({feature:e,timeZone:t})}else if((0,b.nT)(i)){const e=this.relationshipId===r.relationshipId;i.set(s),i.set({map:this.map,showAllEnabled:e})}else(0,m.D7)(i)?(i.set(s),i.set({map:this.map})):i.set(s);if((0,m.CG)(r)){const e=r.elements.filter((e=>z(e)));i.inputs=await this._updateInputsUsingFormElementsRecursive({existingInputsByElement:t,updatedElements:e,sharedInitializationProperties:s,group:i,newExpressionExecutorPromises:a})}}}return o}_updateInputsUsingLayerFields(e,t,i){if(!Array.isArray(t))return P().warn(this.declaredClass,"No attribute fields found."),[];const s=new Map;for(const a of e)if((0,b.Et)(a)){for(const e of a.inputs)e.destroy();a.inputs.length=0,a.destroy()}else(0,b.nT)(a)?a.destroy():(0,b.rf)(a)&&(null!==a.element?a.destroy():s.set(a.field,a));const n=[];for(const a of t){const e=i.feature?.getAttribute(a.name)??null,t=s.get(a)??new M.default({field:a,preservesValueWhenHidden:this.formTemplate?.preserveFieldValuesWhenHidden});n.push(t.set({...i,value:e})),s.delete(a)}for(const[a,o]of s.entries())s.delete(a),o.destroy();return n}_resetFieldInputValues(e){for(const t of this.allFieldInputs)t.value=e.getAttribute(t.name)}_makeInputFromElement(e,t,i){return(0,m.CG)(e)?function(e,t){const{feature:i,layer:s}=t;return new T.default({element:e,inputs:[],feature:i,layer:s})}(e,t):(0,m.jt)(e)?this._makeFieldInputFromElement(e,t,i):(0,m.DN)(e)?this._makeRelationshipInputFromElement(e,t,i):(0,m.D7)(e)?this._makeUtilityNetworkAssociationInputFromElement(e,t,i):(0,m.oo)(e)?function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const{feature:s,layer:n,timeZone:a}=t;return new S.default({element:e,feature:s,group:i,layer:n,timeZone:a})}(e,t):(0,m.D7)(e)?this._makeUtilityNetworkAssociationInputFromElement(e,t,i):(0,a.Xb)()}_makeFieldInputFromElement(e,t,i){const{arcadeEditType:s,feature:n,initialFeature:a,layer:o,timeZone:r}=t,{fieldName:l}=e,u=l&&this._layerFieldsByName.get(l);return u?new M.default({arcadeEditType:s,element:e,field:u,value:n?.getAttribute(e.fieldName)??null,feature:n,initialFeature:a,layer:o,group:i,preservesValueWhenHidden:this.formTemplate?.preserveFieldValuesWhenHidden,timeZone:r}):null}_makeRelationshipInputFromElement(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const{map:s}=this,{feature:n,layer:a,timeZone:o}=t,r=new k.default({element:e,feature:n,group:i,layer:a,map:s,timeZone:o});return r.addHandles((0,d.on)((()=>r.relatedLayer),"edits",(()=>this._expressionsManager?.evaluateAsyncExpressions()))),r}_makeUtilityNetworkAssociationInputFromElement(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const{map:s}=this,{feature:n,layer:a,timeZone:o}=t;return new L.default({element:e,feature:n,group:i,layer:a,map:s,timeZone:o})}_assignExpressionExecutors(e,t,i){const s=D[t.type],n=[];for(const a of s){const s=`${a}Executor`;if(e[s]){this._useExecutor(e[s]);continue}const o=t[a];if(null!=o&&""!==o){const t=this._expressionInfosLookup.get(o)?.expression??o;n.push(this._getOrCreateExecutorForExpression(t,i).then((t=>{e[s]=this._useExecutor(t)})))}}return(0,b.k_)(e)&&n.push(...this._assignTextElementExpressionExecutors(e,i)),n}_assignTextElementExpressionExecutors(e,t){const{_expressionInfosLookup:i}=this,s=[];for(const n of e.expressionsUsed){const a=i.get(n);null!=a?s.push(this._getOrCreateExecutorForExpression(a.expression,t).then((t=>e.setExpressionExecutor(n,this._useExecutor(t))))):r.A.getLogger(this).error("feature-form:expression-not-found",`Could not find expressionInfo object with name '${n}'`)}for(const n of e.fieldsUsed){const i=`return $feature['${n}'];`;s.push(this._getOrCreateExecutorForExpression(i,t).then((t=>e.setFieldExecutor(n,this._useExecutor(t)))))}return s}async _getOrCreateExecutorForExpression(e,t){const{_expressionExecutorLookup:i}=this;if(i.has(e))return i.get(e);if(t.has(e))return t.get(e);const s=(async(e,t)=>{const i=(0,R.createArcadeProfile)("form-calculation"),s=await(0,R.createArcadeExecutor)(e,i,{});return t?.fieldsIndex&&(s.fieldsUsed=(0,U.fixFields)(t.fieldsIndex,s.fieldsUsed)),new H({executor:s})})(e,this.layer);t.set(e,s);const n=await s;return i.set(e,n),n}_createExpressionsManager(e){const{_arcadeContextInfo:t,_featureClone:i,allFieldInputs:s,formTemplate:n}=this;this._expressionsManager=new F({executors:e,feature:i,arcadeContextInfo:t,fieldInputs:s,preserveFieldValuesWhenHidden:!0===n?.preserveFieldValuesWhenHidden})}async _startExpressions(){if(0===this._expressionExecutorsInUse.size)return;const e=Array.from(this._expressionExecutorsInUse);this._createExpressionsManager(e),await this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated()))}_stopExpressions(){this._expressionsManager=(0,l.pR)(this._expressionsManager),this._expressionExecutorsInUse.clear()}_useExecutor(e){return this._expressionExecutorsInUse.add(e),e}_afterValueChange(e){const{name:t,value:i}=e,{_featureClone:s,formTemplate:n,layer:a}=this;if(!a)return;const o=s.getAttribute(t);s.setAttribute(t,i);const{typeFieldName:r,types:l}=(0,b.CU)(a);if((e.isSubtypeField||t===r)&&i!==o){if("subtype-sublayer"===a.type){const e=a.parent?.findSublayerForFeature(s);e&&(this.feature&&(this.feature.sourceLayer=e),s.sourceLayer=e)}const e=new Set;for(const t of l)if(t.domains&&"object"==typeof t.domains)for(const i of Object.keys(t.domains))e.add(i);for(const t of e){const e=this.findField(t);e&&e.notifyChange("domain")}this.notifyChange("joinedContingentValues")}if(null!=n){const{description:e,title:i}=n;i&&(0,c.mk)(i,t)&&this.notifyChange("formTitle"),e&&(0,c.mk)(e,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){const{_featureClone:e}=this;for(const t of this.allFieldInputs)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)}_joinContingentValues(){const e=this._contingentValuesCache;if(null==e)return[];const{typeFieldName:t}=(0,b.CU)(this.layer),i=t?this.getValue(t):null,s=[];for(const o of e.fieldGroups){const{contingencies:e,fields:t,name:n}=o,a=[];for(const s of e)s.isRetired||null!=s.subtype&&s.subtype.code!==i||a.push({values:s.values});a.length>0&&s.push({name:n,fields:t,contingencies:a})}const[n,a]=this._generateJoinPlan(s);return[...n.flatMap((e=>this._joinFieldGroupContingencies(e))),...a.flatMap((e=>e.contingencies))]}_generateJoinPlan(e){const t=new Map,i=[],s=new Set;for(const l of e)for(const e of l.fields)if(t.has(e)){const n=t.get(e),a=l,o=[n.name,a.name].sort().join("|");if(s.has(o))continue;i.push([n,a]),s.add(o),t.set(e,a)}else t.set(e,l);const n=new Set(i.flat()),a=new Set(e);for(const l of n)a.delete(l);const o=new Map,r=new Map;for(const l of new Set(i.flat())){const e=Symbol(l.name);o.set(e,new Set([l])),r.set(l,e)}for(const[l,u]of i){const e=r.get(l),t=r.get(u);if(e===t)continue;const i=o.get(e),s=o.get(t);for(const n of s)i.add(n),r.set(n,e);o.delete(t)}return[[...o.values()].map((e=>[...e])),[...a]]}_joinFieldGroupContingencies(e){const t=e.slice(),i=t.shift();let s=t.shift(),n=this._generateJoinKey(i.fields,s.fields),a=new Set([...i.fields,...s.fields]),o=new Map;for(const l of i.contingencies){const[e]=this._hashContingency(l,n.codedValueFields,!0);o.has(e)?o.get(e)?.push(l):o.set(e,[l])}for(;t.length>0;){const e=new Map,i=t.shift(),r=this._generateJoinKey(a,i.fields);for(const t of s.contingencies){const[i,s]=this._hashContingency(t,n.codedValueFields),a=s?this._findMatchingContingenciesWithAnyHashMask(o,i):o.get(i);if(o.has(j)&&a?.push(...this._findMatchingContingenciesContainingAny(t,o.get(j),n.codedValueFields)),null!=a)for(const o of a){const i=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(o,t,n.rangeFields):this._joinContingencies(o,t);if(null==i)break;const[s]=this._hashContingency(i,r.codedValueFields,!0);e.has(s)?e.get(s)?.push(i):e.set(s,[i])}}o=e,s=i,n=r,a=new Set([...a,...s.fields])}const r=[];for(const l of s.contingencies){const[e,t]=this._hashContingency(l,n.codedValueFields),i=t?this._findMatchingContingenciesWithAnyHashMask(o,e):o.get(e);if(o.has(j)&&i.push(...this._findMatchingContingenciesContainingAny(l,o.get(j),n.codedValueFields)),null!=i)for(const s of i){const e=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(s,l,n.rangeFields):this._joinContingencies(s,l);null!=e&&r.push(e)}}return r}_joinContingencies(e,t){const i={values:{...e.values,...t.values}};for(const[s,n]of Object.entries(i.values))"any"===n.objectType&&null!=e.values[s]&&(i.values[s]=e.values[s]);return i}_joinContingenciesWithRangeDomains(e,t,i){const s=this._joinContingencies(e,t);for(const n of i){const i=e.values[n],a=t.values[n],{leftIsNull:o,rightIsNull:r,bothAreNull:l,leftIsAny:u,rightIsAny:p,bothAreAny:d,leftIsRange:c,rightIsRange:h}=this._compareObjectTypes(i.objectType,a.objectType);if(l||d)continue;if(o&&p||r&&u){s.values[n]=new g.A({objectType:"null"});continue}if(o&&h||r&&c)return null;u?(i.minValue=-1/0,i.maxValue=1/0):p&&(a.minValue=-1/0,a.maxValue=1/0);const f=Math.max(i.minValue,a.minValue),y=Math.min(i.maxValue,a.maxValue);if(f>y)return null;s.values[n]=new g.A({objectType:"range",minValue:f,maxValue:y})}return s}_findMatchingContingenciesContainingAny(e,t,i){return t.filter((t=>i.every((i=>{const s=t.values[i],n=e.values[i];return"any"===s.objectType||"any"===n.objectType||s.codedValue?.code===n.codedValue?.code}))))}_findMatchingContingenciesWithAnyHashMask(e,t){const i=RegExp(`${t}$`),s=[];for(const[n,a]of e){if(n===j)break;i.test(n)&&s.push(...a)}return s}_generateJoinKey(e,t){const i=Array.isArray(e)?new Set(e):e,s=Array.isArray(t)?new Set(t):t,n=i.size<s.size?i:s,a=n===i?s:i,{feature:o}=this,r=new Set,l=new Set;for(const u of n)if(a.has(u)){const e=this.layer?.getFieldDomain(u,{feature:o??void 0,excludeImpliedDomains:!0});if(null==e)continue;switch(e.type){case"coded-value":r.add(u);break;case"range":l.add(u)}}return{codedValueFields:[...r],rangeFields:[...l]}}_contingencyIsValid(e,t){const i={};for(const{name:s,value:n}of this.allFieldInputs)this.fieldsWithContingentValues.has(s)&&null!=n&&s!==e&&(i[s]=n);return Object.entries(i).every((e=>{let[i,s]=e;return!t.values.hasOwnProperty(i)||(0,b.Kl)(s,t.values[i])}))}_getContingentValueOptionsForField(e,t){const i=this.joinedContingentValues.slice(),s=new Map,n={code:"",name:t??"No value"};for(const a of i){const t=a.values[e];if("code"===t?.objectType||"null"===t?.objectType){const{code:i,name:o}=t.codedValue&&"null"!==t.objectType?t.codedValue:n;!s.has(i)&&this._contingencyIsValid(e,a)&&s.set(i,{name:o,value:i})}}return[...s.values()]}_hashContingency(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.length<1)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const s=[];let n=!1;for(const a of t){const t=e.values[a];if("any"===t.objectType){if(i)return[j,!0];n=!0,s.push(`${a}:.*`)}else"null"===t.objectType?s.push(`${a}:#JSAPI_CONTINGENT_VALUE_NULL_HASH`):s.push(`${a}:${t.codedValue?.code}`)}return[s.sort().join("&"),n]}_compareObjectTypes(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}}get test(){return{featureClone:this._featureClone}}};function z(e){return"field"===e.type||"group"===e.type||"relationship"===e.type||"text"===e.type||"utilityNetworkAssociations"===e.type||(P().warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}(0,s._)([(0,h.MZ)()],W.prototype,"_expressionInfosLookup",null),(0,s._)([(0,h.MZ)()],W.prototype,"_featureClone",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"_timeZone",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"activeAssociation",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"activeAssociationInput",null),(0,s._)([(0,h.MZ)()],W.prototype,"activeRelationshipInput",null),(0,s._)([(0,h.MZ)()],W.prototype,"_arcadeContextInfo",null),(0,s._)([(0,h.MZ)()],W.prototype,"associationId",null),(0,s._)([(0,h.MZ)()],W.prototype,"associatedLayer",null),(0,s._)([(0,h.MZ)()],W.prototype,"allAssociationInputs",null),(0,s._)([(0,h.MZ)()],W.prototype,"allFieldInputs",null),(0,s._)([(0,h.MZ)()],W.prototype,"allGroupInputs",null),(0,s._)([(0,h.MZ)()],W.prototype,"allRelationshipInputs",null),(0,s._)([(0,h.MZ)()],W.prototype,"_layerFieldsByName",null),(0,s._)([(0,h.MZ)()],W.prototype,"arcadeEditType",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"contingencyConstraintViolations",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"disabled",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"feature",null),(0,s._)([(0,h.MZ)()],W.prototype,"fieldsWithContingentValues",null),(0,s._)([(0,h.MZ)({type:_.default})],W.prototype,"formTemplate",null),(0,s._)([(0,h.MZ)()],W.prototype,"formDescription",null),(0,s._)([(0,h.MZ)()],W.prototype,"formTitle",null),(0,s._)([(0,h.MZ)()],W.prototype,"formHeaderVisible",null),(0,s._)([(0,h.MZ)()],W.prototype,"highlightHelper",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"inputs",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"joinedContingentValues",null),(0,s._)([(0,h.MZ)()],W.prototype,"layer",null),(0,s._)([(0,h.MZ)()],W.prototype,"map",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"callbacks",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"relationshipId",null),(0,s._)([(0,h.MZ)()],W.prototype,"spatialReference",null),(0,s._)([(0,h.MZ)()],W.prototype,"state",null),(0,s._)([(0,h.MZ)()],W.prototype,"strict",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"submittable",null),(0,s._)([(0,h.MZ)()],W.prototype,"timeZone",null),(0,s._)([(0,h.MZ)()],W.prototype,"updating",null),(0,s._)([(0,h.MZ)()],W.prototype,"valid",null),(0,s._)([(0,h.MZ)()],W.prototype,"pendingSubtypeChoice",void 0),(0,s._)([(0,h.MZ)()],W.prototype,"getValues",null),(0,s._)([(0,h.MZ)()],W.prototype,"submit",null),(0,s._)([(0,h.MZ)()],W.prototype,"test",null),W=(0,s._)([(0,f.$)($)],W);const G=W}}]);
//# sourceMappingURL=87102.7582d2f4.chunk.js.map